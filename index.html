<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einb√ºrgerungstest - Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 24px;
            margin-bottom: 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        h1 {
            font-size: 24px;
            color: #1f2937;
            margin-bottom: 24px;
            text-align: center;
        }

        .question {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .option {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            margin-bottom: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .option:hover:not(.disabled) {
            border-color: #667eea;
            background: #f3f4ff;
        }

        .option.selected {
            border-color: #667eea;
            background: #f3f4ff;
        }

        .option.correct {
            border-color: #10b981;
            background: #d1fae5;
        }

        .option.wrong {
            border-color: #ef4444;
            background: #fee2e2;
        }

        .option.disabled {
            cursor: not-allowed;
        }

        .option-letter {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .option-text {
            flex: 1;
            line-height: 1.5;
        }

        .icon {
            margin-left: 8px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            flex: 1;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e5e7eb;
        }

        .btn-stats {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 16px;
            font-size: 14px;
        }

        .navigation {
            display: flex;
            gap: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .import-section {
            text-align: center;
            padding: 40px 20px;
        }

        .import-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .file-input {
            display: none;
        }

        .code-example {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
        }

        .answer-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .answer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .answer-item.unanswered {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
        }

        .answer-item.correct {
            background: #d1fae5;
            border: 1px solid #10b981;
        }

        .answer-item.incorrect {
            background: #fee2e2;
            border: 1px solid #ef4444;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        @media (max-width: 640px) {
            body {
                padding: 12px;
                padding-bottom: 60px;
            }

            .card {
                padding: 20px;
            }

            .question {
                font-size: 16px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <!-- Load questions -->
    <script src="questions.js"></script>

    <script>
        class QuizApp {
            constructor() {
                this.allQuestions = [];
                this.questions = [];
                this.currentIndex = 0;
                this.answers = {};
                this.view = 'home';
                this.mode = null; // 'full' or 'simulation'
                this.showResult = false;
                this.selectedAnswer = null;
                this.selectedBundesland = 'Sachsen'; // Default Bundesland

                this.bundeslaender = [
                    'Baden-W√ºrttemberg', 'Bayern', 'Berlin', 'Brandenburg',
                    'Bremen', 'Hamburg', 'Hessen', 'Mecklenburg-Vorpommern',
                    'Niedersachsen', 'Nordrhein-Westfalen', 'Rheinland-Pfalz',
                    'Saarland', 'Sachsen', 'Sachsen-Anhalt', 'Schleswig-Holstein', 'Th√ºringen'
                ];

                this.loadData();
                this.render();
            }

            loadData() {
                // First try to load from localStorage
                const stored = localStorage.getItem('quiz-questions');

                if (typeof QUESTIONS_DATA !== 'undefined') {
                    // If we have QUESTIONS_DATA, check if it's different from localStorage
                    let needsUpdate = false;

                    if (stored) {
                        const storedQuestions = JSON.parse(stored);
                        // Check if number of questions is different
                        if (storedQuestions.length !== QUESTIONS_DATA.length) {
                            needsUpdate = true;
                            console.log(`Update: ${storedQuestions.length} ‚Üí ${QUESTIONS_DATA.length} questions`);
                        } else {
                            // Check if content has changed by comparing a sample of questions
                            // Compare first, middle, and last question's correct answer
                            const indices = [0, Math.floor(QUESTIONS_DATA.length / 2), QUESTIONS_DATA.length - 1];
                            for (const idx of indices) {
                                if (storedQuestions[idx].correct !== QUESTIONS_DATA[idx].correct ||
                                    storedQuestions[idx].question !== QUESTIONS_DATA[idx].question) {
                                    needsUpdate = true;
                                    console.log('Update: Questions content has changed');
                                    break;
                                }
                            }
                        }

                        if (needsUpdate) {
                            this.allQuestions = QUESTIONS_DATA;
                            this.saveAllQuestions();
                        } else {
                            this.allQuestions = storedQuestions;
                        }
                    } else {
                        // If nothing in localStorage, load from questions.js
                        this.allQuestions = QUESTIONS_DATA;
                        this.saveAllQuestions();
                        console.log('Loaded questions from file');
                    }
                } else if (stored) {
                    // Fallback: use only localStorage if QUESTIONS_DATA is not available
                    this.allQuestions = JSON.parse(stored);
                }

                // Load mode and active questions
                const storedMode = localStorage.getItem('quiz-mode');
                if (storedMode) {
                    this.mode = storedMode;
                    const storedActiveQuestions = localStorage.getItem('quiz-active-questions');
                    if (storedActiveQuestions) {
                        this.questions = JSON.parse(storedActiveQuestions);
                        this.view = 'quiz';
                    }
                }

                const storedAnswers = localStorage.getItem('quiz-answers');
                if (storedAnswers) {
                    this.answers = JSON.parse(storedAnswers);
                }

                // Load selected Bundesland
                const storedBundesland = localStorage.getItem('quiz-bundesland');
                if (storedBundesland) {
                    this.selectedBundesland = storedBundesland;
                }
            }

            saveAllQuestions() {
                localStorage.setItem('quiz-questions', JSON.stringify(this.allQuestions));
            }

            saveActiveQuestions() {
                localStorage.setItem('quiz-active-questions', JSON.stringify(this.questions));
            }

            saveMode() {
                localStorage.setItem('quiz-mode', this.mode);
            }

            saveBundesland() {
                localStorage.setItem('quiz-bundesland', this.selectedBundesland);
            }

            selectBundesland(bundesland) {
                this.selectedBundesland = bundesland;
                this.saveBundesland();
                this.render();
            }

            getAvailableBundeslaender() {
                // Return list of Bundesl√§nder that have at least 3 questions
                const bundeslaenderCount = {};
                this.allQuestions
                    .filter(q => q.id > 300 && q.bundesland)
                    .forEach(q => {
                        bundeslaenderCount[q.bundesland] = (bundeslaenderCount[q.bundesland] || 0) + 1;
                    });

                return Object.keys(bundeslaenderCount).filter(bl => bundeslaenderCount[bl] >= 3);
            }

            startQuiz(mode) {
                this.mode = mode;
                this.saveMode();

                if (mode === 'full') {
                    // Use all 310 questions
                    this.questions = [...this.allQuestions];
                } else if (mode === 'simulation') {
                    // Select 30 random questions from the first 300 (federal questions)
                    const generalQuestions = this.allQuestions.filter(q => q.id <= 300);
                    const selectedGeneral = this.getRandomQuestions(generalQuestions, 30);

                    // Select 3 random questions from selected Bundesland
                    const regionalQuestions = this.allQuestions.filter(q =>
                        q.id > 300 && q.bundesland === this.selectedBundesland
                    );

                    if (regionalQuestions.length >= 3) {
                        const selectedRegional = this.getRandomQuestions(regionalQuestions, 3);
                        // Combine questions (30 federal + 3 regional = 33 total)
                        this.questions = [...selectedGeneral, ...selectedRegional];
                    } else {
                        // If not enough regional questions available, show alert
                        alert(`Sorry, regional questions for ${this.selectedBundesland} are not yet available. Using Sachsen questions instead.`);
                        const fallbackRegional = this.allQuestions.filter(q =>
                            q.id > 300 && q.bundesland === 'Sachsen'
                        );
                        const selectedRegional = this.getRandomQuestions(fallbackRegional, 3);
                        this.questions = [...selectedGeneral, ...selectedRegional];
                    }
                }

                this.saveActiveQuestions();
                this.currentIndex = 0;
                this.answers = {};
                this.saveAnswers();
                this.view = 'quiz';
                this.render();
            }

            getRandomQuestions(questions, count) {
                const shuffled = [...questions].sort(() => Math.random() - 0.5);
                return shuffled.slice(0, count);
            }

            returnToHome() {
                if (confirm('Do you want to return to home? Current progress will be lost.')) {
                    this.mode = null;
                    this.questions = [];
                    this.answers = {};
                    this.currentIndex = 0;
                    localStorage.removeItem('quiz-mode');
                    localStorage.removeItem('quiz-active-questions');
                    localStorage.removeItem('quiz-answers');
                    this.view = 'home';
                    this.render();
                }
            }

            saveAnswers() {
                localStorage.setItem('quiz-answers', JSON.stringify(this.answers));
            }

            handleAnswer(index) {
                if (this.showResult) return;
                
                this.selectedAnswer = index;
                this.showResult = true;
                
                const correct = index === this.questions[this.currentIndex].correct;
                this.answers[this.currentIndex] = {
                    selected: index,
                    correct: correct,
                    timestamp: Date.now()
                };
                
                this.saveAnswers();
                this.render();
            }

            nextQuestion() {
                if (this.currentIndex < this.questions.length - 1) {
                    this.currentIndex++;
                    this.selectedAnswer = null;
                    this.showResult = false;
                    this.render();
                }
            }

            prevQuestion() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.selectedAnswer = null;
                    this.showResult = false;
                    this.render();
                }
            }

            goToQuestion(questionId) {
                const id = parseInt(questionId);

                // Input validation
                if (!questionId || isNaN(id)) {
                    alert('Please enter a valid question number.');
                    return;
                }

                if (id < 1 || id > 310) {
                    alert('Question number must be between 1 and 310.');
                    return;
                }

                // Find the index of the question with the specified ID
                const index = this.questions.findIndex(q => q.id === id);
                if (index !== -1) {
                    this.currentIndex = index;
                    this.selectedAnswer = null;
                    this.showResult = false;
                    this.render();
                } else {
                    alert(`Question ${id} not found in this mode.`);
                }
            }

            resetProgress() {
                if (confirm('Do you really want to reset all progress for this session?')) {
                    this.answers = {};
                    this.currentIndex = 0;
                    this.saveAnswers();
                    this.selectedAnswer = null;
                    this.showResult = false;
                    this.render();
                }
            }

            reloadQuestions() {
                if (confirm('Do you want to reload the original questions? This will keep your progress.')) {
                    if (typeof QUESTIONS_DATA !== 'undefined') {
                        this.allQuestions = QUESTIONS_DATA;
                        this.saveAllQuestions();
                        alert('Questions reloaded successfully!');
                        this.render();
                    }
                }
            }

            importFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        this.allQuestions = imported;
                        this.saveAllQuestions();
                        alert(`${imported.length} questions imported successfully!`);
                        this.view = 'home';
                        this.render();
                    } catch (error) {
                        alert('Error in JSON file. Please check the format.');
                    }
                };
                reader.readAsText(file);
            }

            getStats() {
                const answered = Object.keys(this.answers).length;
                const correct = Object.values(this.answers).filter(a => a.correct).length;
                const percentage = answered > 0 ? Math.round((correct / answered) * 100) : 0;
                return { answered, correct, percentage, total: this.questions.length };
            }

            render() {
                const app = document.getElementById('app');

                if (this.allQuestions.length === 0) {
                    app.innerHTML = this.renderImport();
                } else if (this.view === 'home') {
                    app.innerHTML = this.renderHome();
                } else if (this.view === 'stats') {
                    app.innerHTML = this.renderStats();
                } else {
                    app.innerHTML = this.renderQuiz();
                }

                this.attachEventListeners();
            }

            renderHome() {
                // Check available Bundesl√§nder
                const availableBundeslaender = this.getAvailableBundeslaender();

                return `
                    <div class="card">
                        <h1>üá©üá™ Einb√ºrgerungstest</h1>
                        <p style="text-align: center; color: #6b7280; margin-bottom: 24px;">
                            Choose your practice mode
                        </p>

                        <div style="margin-bottom: 24px; padding: 16px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;">
                            <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                üó∫Ô∏è Your Bundesland:
                            </label>
                            <select
                                id="bundeslandSelect"
                                onchange="app.selectBundesland(this.value)"
                                style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;"
                            >
                                ${this.bundeslaender.map(bl => {
                                    const available = availableBundeslaender.includes(bl);
                                    const selected = bl === this.selectedBundesland ? 'selected' : '';
                                    const label = available ? bl : `${bl} (not yet available)`;
                                    return `<option value="${bl}" ${selected}>${label}</option>`;
                                }).join('')}
                            </select>
                            <p style="font-size: 12px; color: #6b7280; margin-top: 8px; margin-bottom: 0;">
                                The test includes 3 random questions specific to your Bundesland
                            </p>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <button class="btn btn-primary" onclick="app.startQuiz('full')" style="padding: 24px;">
                                <div style="text-align: left; width: 100%;">
                                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">
                                        üìö All Questions
                                    </div>
                                    <div style="font-size: 14px; opacity: 0.9;">
                                        Practice with all 310 questions
                                    </div>
                                </div>
                            </button>

                            <button class="btn" onclick="app.startQuiz('simulation')" style="padding: 24px; background: linear-gradient(135deg, #10b981, #059669); color: white;">
                                <div style="text-align: left; width: 100%;">
                                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">
                                        ‚úÖ Test Simulation
                                    </div>
                                    <div style="font-size: 14px; opacity: 0.9;">
                                        33 random questions (30 federal + 3 regional)
                                    </div>
                                </div>
                            </button>
                        </div>

                        <div style="margin-top: 32px; padding: 16px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 14px; color: #6b7280; line-height: 1.6;">
                                <strong style="color: #374151;">‚ÑπÔ∏è About the test:</strong><br>
                                The real naturalization test consists of 33 questions:<br>
                                ‚Ä¢ 30 random questions from the federal catalog (questions 1-300)<br>
                                ‚Ä¢ 3 random questions from your Bundesland (questions 301-310 for Sachsen)<br><br>
                                To pass, you need to answer at least 17 questions correctly (‚â•51.5%).
                            </div>
                        </div>
                    </div>
                `;
            }

            renderImport() {
                // If QUESTIONS_DATA is available, show a different message
                if (typeof QUESTIONS_DATA !== 'undefined') {
                    return `
                        <div class="card">
                            <div class="import-section">
                                <div class="import-icon">‚ö†Ô∏è</div>
                                <h1>Loading Error</h1>
                                <p style="color: #6b7280; margin-bottom: 24px;">
                                    Questions should load automatically.<br>
                                    If you see this message, try reloading the page.
                                </p>

                                <button class="btn btn-primary" onclick="location.reload()">
                                    üîÑ Reload Page
                                </button>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="card">
                        <div class="import-section">
                            <div class="import-icon">üìö</div>
                            <h1>Einb√ºrgerungstest Quiz</h1>
                            <p style="color: #6b7280; margin-bottom: 24px;">
                                Import test questions to start practicing
                            </p>

                            <div class="code-example">
[
  {
    "id": 1,
    "question": "Question text?",
    "options": [
      "Answer A",
      "Answer B",
      "Answer C",
      "Answer D"
    ],
    "correct": 0
  }
]
                            </div>

                            <label class="btn btn-primary" style="display: inline-flex; cursor: pointer;">
                                üì§ Import Questions (JSON)
                                <input type="file" accept=".json" class="file-input" id="fileInput">
                            </label>
                        </div>
                    </div>
                `;
            }

            renderQuiz() {
                const question = this.questions[this.currentIndex];
                const progress = ((this.currentIndex + 1) / this.questions.length) * 100;
                const modeLabel = this.mode === 'simulation' ? 'üéØ Simulation Mode' : 'üìö Full Practice';

                return `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                            <button class="btn-stats" onclick="app.returnToHome();" style="border-color: #6b7280; color: #6b7280;">
                                ‚Üê Home
                            </button>
                            <div style="font-size: 12px; font-weight: 600; color: #667eea; padding: 4px 12px; background: #f3f4ff; border-radius: 8px;">
                                ${modeLabel}
                            </div>
                            <button class="btn-stats" onclick="app.view = 'stats'; app.render();">
                                üìä Stats
                            </button>
                        </div>
                        <div class="header">
                            <div style="font-size: 14px; font-weight: 600; color: #6b7280;">
                                Question ${this.currentIndex + 1} of ${this.questions.length}
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <div class="card">
                        ${question.image ? `<div style="text-align: center; margin-bottom: 20px;"><img src="${question.image}" alt="Domanda ${question.id}" style="max-width: 100%; height: auto; border-radius: 8px;"></div>` : ''}
                        <div class="question">${question.question}</div>
                        <div>
                            ${question.options.map((option, idx) => {
                                const isSelected = this.selectedAnswer === idx;
                                const isCorrect = idx === question.correct;
                                const showCorrect = this.showResult && isCorrect;
                                const showWrong = this.showResult && isSelected && !isCorrect;
                                
                                let className = 'option';
                                if (showCorrect) className += ' correct';
                                else if (showWrong) className += ' wrong';
                                else if (isSelected) className += ' selected';
                                if (this.showResult) className += ' disabled';

                                return `
                                    <div class="${className}" onclick="${this.showResult ? '' : `app.handleAnswer(${idx})`}">
                                        <div class="option-letter">${String.fromCharCode(65 + idx)}</div>
                                        <div class="option-text">${option}</div>
                                        ${showCorrect ? '<span style="color: #10b981; font-weight: bold;">‚úì</span>' : ''}
                                        ${showWrong ? '<span style="color: #ef4444; font-weight: bold;">‚úó</span>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="card">
                        <div class="navigation">
                            <button class="btn btn-secondary" onclick="app.prevQuestion()" ${this.currentIndex === 0 ? 'disabled' : ''}>
                                ‚Üê Previous
                            </button>
                            <button class="btn btn-primary" onclick="app.nextQuestion()" ${this.currentIndex === this.questions.length - 1 ? 'disabled' : ''}>
                                Next ‚Üí
                            </button>
                        </div>
                        ${this.mode === 'full' ? `
                        <div style="margin-top: 16px; display: flex; align-items: center; gap: 12px;">
                            <label style="font-size: 14px; font-weight: 600; color: #6b7280;">Go to question:</label>
                            <input
                                type="number"
                                id="questionNumberInput"
                                min="1"
                                max="310"
                                placeholder="e.g. 258"
                                style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"
                                onkeypress="if(event.key === 'Enter') app.goToQuestion(this.value)"
                            >
                            <button class="btn btn-secondary" onclick="app.goToQuestion(document.getElementById('questionNumberInput').value)" style="white-space: nowrap;">
                                Jump
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            renderStats() {
                const stats = this.getStats();
                const modeLabel = this.mode === 'simulation' ? 'üéØ Simulation Mode' : 'üìö Full Practice';
                const passThreshold = this.mode === 'simulation' ? 17 : Math.ceil(this.questions.length * 0.515);
                const hasPassed = stats.correct >= passThreshold;

                return `
                    <div class="card">
                        <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                            <button class="btn-stats" onclick="app.view = 'quiz'; app.render();">
                                ‚Üê Back to Quiz
                            </button>
                            <button class="btn-stats" onclick="app.returnToHome();" style="border-color: #6b7280; color: #6b7280;">
                                üè† Home
                            </button>
                        </div>

                        <h1>üìä Statistics</h1>
                        <div style="text-align: center; margin-bottom: 16px; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                            <span style="font-size: 12px; font-weight: 600; color: #667eea; padding: 4px 12px; background: #f3f4ff; border-radius: 8px;">
                                ${modeLabel}
                            </span>
                            ${this.mode === 'simulation' ? `
                            <span style="font-size: 12px; font-weight: 600; color: #059669; padding: 4px 12px; background: #d1fae5; border-radius: 8px;">
                                üó∫Ô∏è ${this.selectedBundesland}
                            </span>
                            ` : ''}
                        </div>

                        ${this.mode === 'simulation' && stats.answered === stats.total ? `
                        <div style="text-align: center; padding: 20px; margin-bottom: 16px; border-radius: 12px; background: ${hasPassed ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'}; color: white;">
                            <div style="font-size: 48px; margin-bottom: 8px;">${hasPassed ? '‚úÖ' : '‚ùå'}</div>
                            <div style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">
                                ${hasPassed ? 'PASSED!' : 'NOT PASSED'}
                            </div>
                            <div style="font-size: 14px; opacity: 0.9;">
                                You need ${passThreshold} correct answers to pass (${stats.correct}/${stats.total})
                            </div>
                        </div>
                        ` : ''}

                        <div class="stats-grid">
                            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                                <div class="stat-value">${stats.answered}</div>
                                <div class="stat-label">Answered</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                                <div class="stat-value">${stats.correct}</div>
                                <div class="stat-label">Correct</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <div class="stat-value">${stats.percentage}%</div>
                                <div class="stat-label">Percentage</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #6b7280, #4b5563);">
                                <div class="stat-value">${stats.total}</div>
                                <div class="stat-label">Total Questions</div>
                            </div>
                        </div>

                        <h3 style="margin-bottom: 12px; color: #374151;">Answer Details</h3>
                        <div class="answer-list">
                            ${this.questions.map((q, idx) => {
                                const answer = this.answers[idx];
                                let className = 'answer-item ';
                                let badge = '';
                                
                                if (!answer) {
                                    className += 'unanswered';
                                    badge = '<span class="badge" style="background: #e5e7eb; color: #374151;">Not answered</span>';
                                } else if (answer.correct) {
                                    className += 'correct';
                                    badge = '<span class="badge" style="background: #10b981; color: white;">‚úì Correct</span>';
                                } else {
                                    className += 'incorrect';
                                    badge = '<span class="badge" style="background: #ef4444; color: white;">‚úó Wrong</span>';
                                }

                                return `
                                    <div class="${className}">
                                        <span style="font-weight: 600;">Question ${q.id}</span>
                                        ${badge}
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button class="btn" onclick="app.resetProgress()" style="flex: 1; background: #f59e0b; color: white;">
                                üîÑ Reset Progress
                            </button>
                            ${this.mode === 'simulation' ? `
                            <button class="btn" onclick="app.startQuiz('simulation')" style="flex: 1; background: #10b981; color: white;">
                                üé≤ New Test
                            </button>
                            ` : ''}
                        </div>

                        ${typeof QUESTIONS_DATA !== 'undefined' ? `
                        <button class="btn" onclick="app.reloadQuestions()" style="width: 100%; background: #667eea; color: white; margin-top: 12px;">
                            üîÑ Reload Original Questions
                        </button>
                        ` : ''}
                    </div>
                `;
            }

            attachEventListeners() {
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => this.importFile(e));
                }
            }
        }

        const app = new QuizApp();
    </script>
</body>
</html>